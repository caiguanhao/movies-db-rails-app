<div class="row movie-info">
  <div class="col-sm-3">
    <%= image_tag @movie.poster, width: 270, height: 405, class: 'img-responsive' %>
  </div>
  <div class="col-sm-9">
    <div class="movie-ratings pull-right">
      <h2><%= @movie.ratings %></h2>
      <span class="movie-rating comment-rating" data-rating="<%= @movie.ratings %>"></span>
      <span class="movie-ratings-bottom">评分</span>
    </div>
    <h2>
      <%= @movie.name %>
      <small>(<%= @movie.year %>)</small>
      <% if is_admin? %>
        <div class="btn-group">
          <%= link_to '新增电影', new_movie_path(@movie), class: 'btn btn-sm btn-default' %>
          <%= link_to '编辑电影', edit_movie_path(@movie), class: 'btn btn-sm btn-default' %>
          <%= link_to '新增时间', new_movie_timetable_path(@movie), class: 'btn btn-sm btn-default' %>
        </div>
      <% end %>
    </h2>
    <h4><%= @movie.alias %></h4>
    <p>主演：<%= @movie.star %></p>
    <p>导演：<%= @movie.director %></p>
    <p>编剧：<%= @movie.writer %></p>
    <p>国家：<%= @movie.country %></p>
    <p>上映：<%= @movie.release_date %></p>
    <p>片长：<%= @movie.runtime %>分钟</p>
    <p>又名：<%= @movie.aka %></p>
    <p>类型：<%= @movie.genre %></p>
    <%= simple_format @movie.content %>
    <div class="col-sm-8 movie-comment-block">
      <% if user_signed_in? %>
        <%= bootstrap_form_for @comment, url: comments_movie_path(@movie) do |f| %>
          <%= f.label :rating %>
          <span class="movie-rating" id="rating"></span>
          <%= f.hidden_field :rating %>
          <%= f.text_area :content, skip_label: true, rows: 3, placeholder: "您还没有发表影评" %>
          <%= f.submit "发表", disabled: @comment.rating.nil? %>
        <% end %>
        <script>
          $(function () {
            $("#rating").rateYo({
              rating: $("#rating").siblings('input[name="comment[rating]"]').val() || 0,
              starWidth: '16px',
              fullStar: true,
              onChange: function (rating, instance) {
                $(instance.node).siblings('input[name="comment[rating]"]').val(rating);
                $(instance.node).siblings('input[type=submit]').prop('disabled', rating === 0);
              }
            });
          });
        </script>
      <% else %>
        <%= link_to "登录", new_user_session_path %>后发表影评。
      <% end %>
    </div>
  </div>
</div>

<div class="row movie-timetables">
  <div class="col-sm-12">
    <ul class="nav nav-tabs">
      <li class="no-link"><a>上映影院</a></li>
      <% @dates.each.with_index do |date, i| %>
        <li class="<%= i == 0 && ' active' || '' %>"><a href="#date-<%= date %>" data-toggle="tab" class="movie-timetable-date"><%= date %></a></li>
      <% end %>
      <li class="dropdown pull-right">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#"><span id="timetables-district">选择地区</span> <span class="caret"></span></a>
        <ul id="timetables-districts" class="dropdown-menu"></ul>
      </li>
    </ul>
    <div class="tab-content">
      <% if @dates.length == 0 %>
        <p class="movie-timetable-none">当前城市没有影院上映这部电影。</p>
      <% end %>
      <% @dates.each.with_index do |date, i| %>
        <div class="tab-pane<%= i == 0 && ' active' || '' %>" id="date-<%= date %>">
          <table class="table movie-timetable">
            <tbody>
              <% @timetables_by_date[i].each do |_, tts| %>
                <% tt = tts[0] %>
                <tr data-district="<%= tt.cinema.district %>">
                  <td>
                    <%= link_to tt.cinema do %>
                      <%= image_tag tt.cinema.logo, width: 102, height: 44 %>
                    <% end %>
                  </td>
                  <td><%= link_to tt.cinema.name, tt.cinema %></td>
                  <td><%= tt.date.strftime('%F') %></td>
                  <td class="text-right"><%= tts.map(&:time).minmax.map{|t|t.strftime('%T')}.join(' - ') %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>
</div>
<script>
(function () {
  var preferredDistrict = localStorage.selectedDistrict;
  function updateTimetableDistricts () {
    var districts = $.grep($.unique(
      $('.movie-timetables .tab-pane.active tr[data-district]').map(function() {
        return $(this).data('district');
      })), function (item) {
      return !!item;
    });
    districts.sort();
    $('#timetables-districts').empty();
    $.each(districts, function (i, district) {
      var count = $('.movie-timetables .tab-pane.active tr[data-district="' + district + '"]').length;
      $('#timetables-districts').append('<li><a href data-district="' + district + '">' + district + ' (' + count + ')</a></li>');
    });
    $(document).on('click', '#timetables-districts a', function (e) {
      e.preventDefault();
      var district = $(this).data('district');
      $('#timetables-district').text(district);
      $('.movie-timetables .tab-pane.active tr[data-district]').addClass('hide');
      $('.movie-timetables .tab-pane.active tr[data-district="' + district + '"]').removeClass('hide');
      preferredDistrict = district;
      if (localStorage) {
        localStorage.selectedDistrict = district;
      }
    });
    if (preferredDistrict) {
      $('#timetables-districts a[data-district="' + preferredDistrict + '"]').click();
    } else {
      $('#timetables-districts a:first').click();
    }
  }
  $('.movie-timetable-date').on('shown.bs.tab', function (e) {
    updateTimetableDistricts();
  });
  updateTimetableDistricts();
})();
</script>

<div class="row movie-comments">
  <div class="col-sm-12">
    <ul class="nav nav-tabs">
      <li class="no-link"><a>影评</a></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane active">
        <table class="table movie-comment">
          <tbody>
            <% if @comments.size > 0 %>
              <% @comments.each do |comment| %>
                <tr>
                  <td class="movie-comment-user">
                    <%= link_to user_path(comment.user) do %>
                      <%= image_tag comment.user.avatar || 'user.png', width: 32, height: 32, class: 'user-avatar' %>
                      <%= comment.user.name || comment.user.email %>
                    <% end %>
                  </td>
                  <td class="movie-comment-rating">
                    <span class="comment-rating" data-rating="<%= comment.rating %>"></span>
                    <%= time_ago_in_words comment.updated_at %>
                  </td>
                  <td><%= simple_format comment.content %></td>
                </tr>
              <% end %>
            <% else %>
              <tr><td>还没有人发表过影评。</td></tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
  $(function () {
    $(".comment-rating").each(function () {
      $(this).rateYo({
        rating: $(this).data('rating') || 0,
        starWidth: '16px',
        readOnly: true,
      });
    });
  });
</script>
